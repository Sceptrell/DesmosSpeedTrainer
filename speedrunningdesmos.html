<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Random Formula Desmos Checker</title>

<script src="https://www.desmos.com/api/v1.11/calculator.js?apiKey=4435f284d2154cf48e80abbbffc842cd"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.10.0/math.js"></script>

<style>
body { font-family: sans-serif; text-align: center; margin: 20px; }
#calculator { width: 100%; height: 500px; margin-top: 20px; border: 1px solid #ccc; }
.formula-box { margin: 10px; font-size: 20px; }
button { padding: 10px 20px; margin-top: 10px; font-size: 16px; cursor: pointer; }
#user-latex { margin-top: 10px; font-size: 20px; color: blue; min-height: 30px; }
</style>
</head>
<body>

<h1>Random Formula Desmos Checker</h1>

<p class="formula-box">Target Formula: <span id="target-latex"></span></p>
<p class="formula-box">Your Input (Desmos): <span id="user-latex">Nothing yet...</span></p>

<button id="check-answer">Check Answer</button>
<button id="new-formula">New Random Formula</button>
<p id="result" style="font-weight:bold; margin-top:10px;"></p>

<div id="calculator"></div>

<script>
// ===== Initialize Desmos =====
var elt = document.getElementById('calculator');
var calculator = Desmos.GraphingCalculator(elt);

let userLatex = "";
calculator.observeEvent('change', function() {
  let expressions = calculator.getExpressions();
  if (expressions.length > 0) {
    userLatex = expressions[expressions.length-1].latex;
    try {
      katex.render(userLatex, document.getElementById('user-latex'), {throwOnError: false});
    } catch(e) {
      document.getElementById('user-latex').innerText = userLatex;
    }
  } else {
    userLatex = "";
    document.getElementById('user-latex').innerText = "Nothing yet...";
  }
});

// ===== Helpers =====
function latexToMathjs(latex) {
  let expr = latex;
  expr = expr.replace(/^y=/,'');
  expr = expr.replace(/\\frac{([^}]+)}{([^}]+)}/g,'($1)/($2)');
  expr = expr.replace(/\\sqrt{([^}]*)}/g,'sqrt($1)');
  expr = expr.replace(/\^\{([^}]*)\}/g,'^($1)');
  expr = expr.replace(/\\cdot/g,'*');
  expr = expr.replace(/\\left/g,'').replace(/\\right/g,'');
  expr = expr.replace(/\|([^|]+)\|/g,'abs($1)');
  expr = expr.replace(/\s+/g,'');
  return expr;
}

function checkEquivalenceRobust(userLatex,targetLatexArray){
  try{
    const userExpr = latexToMathjs(userLatex);
    for(const targetLatex of targetLatexArray){
      const targetExpr = latexToMathjs(targetLatex);
      const diff = math.simplify(`(${userExpr})-(${targetExpr})`).toString();
      const testPoints=[-10,-5,-1,0,1,2,5,10];
      const tolerance=1e-6;
      let match=true;
      for(let x of testPoints){
        const val=math.evaluate(diff,{x});
        if(Math.abs(val)>tolerance){match=false; break;}
      }
      if(match) return true;
    }
    return false;
  }catch(e){return false;}
}

function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function formatTerm(coef, variable='') {
    if(coef===0) return '';
    if(coef===1) return variable;
    if(coef===-1) return `-${variable}`;
    if(coef>0) return `+${coef}${variable}`;
    return `${coef}${variable}`;
}
function formatFactor(x) {return x<0? `(x+${Math.abs(x)})` : `(x-${x})`;}

// ===== Formula Generators =====
function generateLinear() {
    const m = randInt(-5,5), b = randInt(-10,10);
    let formula = '';
    if (m !== 0) formula += formatTerm(m,'x');
    if (b !== 0) formula += formatTerm(b);
    if (formula.startsWith('+')) formula = formula.slice(1);
    return [`y=${formula||'0'}`];
}

function generateQuadraticStandard() {
    const a = randInt(1,5), b = randInt(-10,10), c = randInt(-10,10);
    let formula = formatTerm(a,'x^2') + formatTerm(b,'x') + formatTerm(c);
    if (formula.startsWith('+')) formula = formula.slice(1);
    return [`y=${formula}`];
}

function generateQuadraticVertex() {
    const a = randInt(1,5), h = randInt(-5,5), k = randInt(-10,10);
    const hx = h<0 ? `(x+${Math.abs(h)})` : `(x-${h})`;
    const ky = k<0 ? `-${Math.abs(k)}` : `${k}`;
    return [`y=${a}${hx}^2+${ky}`];
}

function generateQuadraticFactored() {
    const a = randInt(1,5), r1 = randInt(-5,5), r2 = randInt(-5,5);
    return [`y=${a}${formatFactor(r1)}${formatFactor(r2)}`];
}

function generateCubicStandard() {
    const a=randInt(1,3), b=randInt(-5,5), c=randInt(-5,5), d=randInt(-5,5);
    let formula = formatTerm(a,'x^3') + formatTerm(b,'x^2') + formatTerm(c,'x') + formatTerm(d);
    if (formula.startsWith('+')) formula = formula.slice(1);
    return [`y=${formula}`];
}

function generateCubicFactored() {
    const a=randInt(1,3), r1=randInt(-5,5), r2=randInt(-5,5), r3=randInt(-5,5);
    return [`y=${a}${formatFactor(r1)}${formatFactor(r2)}${formatFactor(r3)}`];
}

function generateQuartic() {
    const a=randInt(1,2), b=randInt(-3,3), c=randInt(-5,5), d=randInt(-5,5), e=randInt(-5,5);
    let formula = formatTerm(a,'x^4') + formatTerm(b,'x^3') + formatTerm(c,'x^2') + formatTerm(d,'x') + formatTerm(e);
    if (formula.startsWith('+')) formula=formula.slice(1);
    return [`y=${formula}`];
}

function generateRational() {
    const a=randInt(1,5), b=randInt(-5,5), c=randInt(1,5), d=randInt(-5,5);
    return [`y=(${a}x+${b})/(${c}x+${d})`];
}

function generateRadical() {
    const a=randInt(1,5), b=randInt(-5,5);
    return [`y=sqrt(${a}x+${b})`];
}

function generateAbsolute() {
    const a=randInt(-5,5), b=randInt(-10,10);
    if(a===0) return [`y=|${b}|`];
    let term = a===1?'x':a===-1?'-x':`${a}x`;
    if(b>0) term+=`+${b}`;
    else if(b<0) term+=`${b}`;
    return [`y=|${term}|`];
}

function generateExponential() {
    const a=randInt(1,5), b=randInt(2,5);
    return [`y=${a}*${b}^x`];
}

function generateCircle() {
    const h=randInt(-5,5), k=randInt(-5,5), r=randInt(1,5);
    const hx = h<0 ? `(x+${Math.abs(h)})` : `(x-${h})`;
    const upper = `y=${k}+sqrt(${r*r}-${hx}^2)`;
    const lower = `y=${k}-sqrt(${r*r}-${hx}^2)`;
    return [upper, lower];
}

function generatePiecewise() {
    const a=randInt(-5,5), b=randInt(-5,5), c=randInt(-5,5), d=randInt(-5,5);
    return [`y=${a}x+${b}`, `y=${c}x+${d}`];
}

function generateSystemLinear() {
    const m1=randInt(-5,5), b1=randInt(-10,10);
    const m2=randInt(-5,5), b2=randInt(-10,10);
    return [`y=${m1}x+${b1}`, `y=${m2}x+${b2}`];
}

function generateInequalityLinear() {
    const a=randInt(-5,5), b=randInt(-5,5), c=randInt(-10,10);
    return [`${a}x+${b}<${c}`];
}

function generateInequalityQuadratic() {
    const a=randInt(1,3), b=randInt(-5,5), c=randInt(-5,5);
    return [`${a}x^2+${b}x+${c}<=0`];
}

function generateFunctionTransform() {
    const a=randInt(-5,5), h=randInt(-3,3), k=randInt(-5,5);
    return [`f(x-${h})*${a}+${k}`];
}

// ===== Generators array =====
const formulaGenerators=[
    generateLinear,
    generateQuadraticStandard,
    generateQuadraticVertex,
    generateQuadraticFactored,
    generateCubicStandard,
    generateCubicFactored,
    generateQuartic,
    generateRational,
    generateRadical,
    generateAbsolute,
    generateExponential,
    generateCircle,
    generatePiecewise,
    generateSystemLinear,
    generateInequalityLinear,
    generateInequalityQuadratic,
    generateFunctionTransform
];

// ===== Generate new random formula =====
let targetFormulaArray=[];
let formulaSolved = false;

function newFormula() {
    calculator.setExpressions([]); // clear Desmos
    const index = randInt(0, formulaGenerators.length-1);
    targetFormulaArray = formulaGenerators[index]();
    let displayLatex = targetFormulaArray[0]; // only first branch
    katex.render(displayLatex, document.getElementById('target-latex'), {throwOnError:false});
    document.getElementById('result').innerText = "";
    formulaSolved = false;
    userLatex = "";
    document.getElementById('user-latex').innerText = "Nothing yet...";
}

// Initial formula
newFormula();

// ===== Button events =====
document.getElementById('check-answer').addEventListener('click',function(){
    if(checkEquivalenceRobust(userLatex,targetFormulaArray)){
        document.getElementById('result').innerText="✅ Correct! Formulas are equivalent!";
        document.getElementById('result').style.color="green";
        formulaSolved = true;
    } else {
        document.getElementById('result').innerText="❌ Not equivalent!";
        document.getElementById('result').style.color="red";
    }
});
document.getElementById('new-formula').addEventListener('click',newFormula);

// ===== Enter key handling =====
document.addEventListener('keydown', function(e) {
    if(e.key === 'Enter'){
        e.preventDefault();
        if(formulaSolved){
            newFormula();
        } else {
            document.getElementById('check-answer').click();
        }
    }
});
</script>
</body>
</html>